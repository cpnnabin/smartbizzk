<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Records - SmartBiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #29AD81;
            --primary-dark: #218a68;
            --primary-light: #4bc299;
            --bg-color: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --card-bg: #ffffff;
            --table-hover: rgba(41, 173, 129, 0.1);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-color: #ffffff;
            --text-muted: #b0b0b0;
            --border-color: #404040;
            --card-bg: #2d2d2d;
            --table-hover: rgba(41, 173, 129, 0.2);
        }

        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-color);
        }

        .card {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        .table {
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .table-hover tbody tr:hover {
            background-color: var(--table-hover);
        }

        .header-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .theme-toggle:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .form-control {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        .form-control:focus {
            background-color: var(--card-bg);
            border-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: 0 0 0 0.2rem rgba(41, 173, 129, 0.25);
        }

        .form-select {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .animate-in {
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
<!-- Theme Toggle Button -->
<button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
    <i class="fas fa-moon" id="theme-icon"></i>
</button>

<div class="container-fluid mt-4 animate-in">
    <div class="header-card text-white rounded-3 p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Transaction Records</h2>
                <p class="mb-0 opacity-75">Track all your income and expense records</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#addRecordModal">
                    <i class="fas fa-plus me-2"></i>Add Record
                </button>
                <button class="btn btn-outline-light" onclick="exportRecords()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header filter-card text-white">
                    <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filter & Search</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="recordSearch" placeholder="Search records...">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="typeFilter">
                                <option value="">All Types</option>
                                <option value="INCOME">Income</option>
                                <option value="EXPENSE">Expense</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="categoryFilter">
                                <option value="">All Categories</option>
                                <option value="Sales">Sales</option>
                                <option value="Office Supplies">Office Supplies</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Travel">Travel</option>
                                <option value="Utilities">Utilities</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Records</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="sortTable('date')">
                            <i class="fas fa-sort me-1"></i>Sort by Date
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="sortTable('amount')">
                            <i class="fas fa-sort-amount-down me-1"></i>Sort by Amount
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="recordsTable">
                            <thead class="table-light">
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="recordsTableBody">
                            <tr th:each="record : ${records}">
                                <td>
                                    <input type="checkbox" class="record-checkbox">
                                </td>
                                <td th:text="${record.date}">2025-01-15</td>
                                <td>
                                    <span th:if="${record.type == 'INCOME'}" class="badge bg-success">Income</span>
                                    <span th:if="${record.type == 'EXPENSE'}" class="badge bg-danger">Expense</span>
                                </td>
                                <td th:text="${record.category}">Sales</td>
                                <td th:text="'₹' + ${record.amount}">₹15,000</td>
                                <td th:text="${record.note}">Product sale to client</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editRecord(this)" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteRecord(this)" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(records)}">
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                    No records found. <a href="#" data-bs-toggle="modal" data-bs-target="#addRecordModal">Add your first record</a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelected()" id="deleteSelectedBtn" style="display: none;">
                                <i class="fas fa-trash me-2"></i>Delete Selected
                            </button>
                        </div>
                        <div>
                            <small class="text-muted">Total Records: <span id="totalRecords">0</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Summary</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Income:</span>
                        <span class="text-success fw-bold" id="totalIncome" th:text="'₹' + ${totalIncome}">₹0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Expense:</span>
                        <span class="text-danger fw-bold" id="totalExpense" th:text="'₹' + ${totalExpense}">₹0</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">Net Amount:</span>
                        <span class="fw-bold" id="netAmount" th:text="'₹' + ${netAmount}">₹0</span>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Monthly Trend</h6>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                </div>
            </div>

            <div class="card shadow-sm mt-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Top Categories</h6>
                </div>
                <div class="card-body">
                    <div class="category-item d-flex justify-content-between align-items-center mb-2">
                        <span>Sales</span>
                        <span class="badge bg-success">₹45,000</span>
                    </div>
                    <div class="category-item d-flex justify-content-between align-items-center mb-2">
                        <span>Office Supplies</span>
                        <span class="badge bg-danger">₹12,500</span>
                    </div>
                    <div class="category-item d-flex justify-content-between align-items-center mb-2">
                        <span>Marketing</span>
                        <span class="badge bg-primary">₹8,200</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="/dashboard" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Add Record Modal -->
<div class="modal fade" id="addRecordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add New Record
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/records/save}" th:object="${record}" method="post" id="recordForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" id="date" th:field="*{date}" class="form-control" required>
                            <div class="invalid-feedback">Please select a date.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="type" class="form-label">Type <span class="text-danger">*</span></label>
                            <select id="type" th:field="*{type}" class="form-select" required onchange="updateCategoryOptions()">
                                <option value="">Select Type</option>
                                <option value="INCOME">Income</option>
                                <option value="EXPENSE">Expense</option>
                            </select>
                            <div class="invalid-feedback">Please select a type.</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                            <input type="text" id="category" th:field="*{category}" class="form-control"
                                   placeholder="e.g., Sales, Office Supplies" required list="categoryList">
                            <datalist id="categoryList">
                                <option value="Sales">
                                <option value="Office Supplies">
                                <option value="Marketing">
                                <option value="Travel">
                                <option value="Utilities">
                                <option value="Professional Services">
                            </datalist>
                            <div class="invalid-feedback">Please enter a category.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Amount <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="amount" th:field="*{amount}" class="form-control"
                                       step="0.01" min="0" placeholder="0.00" required>
                            </div>
                            <div class="invalid-feedback">Please enter a valid amount.</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="note" class="form-label">Note</label>
                        <textarea id="note" th:field="*{note}" class="form-control" rows="3"
                                  placeholder="Additional details (optional)"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method</label>
                            <select id="paymentMethod" class="form-select">
                                <option value="">Select Method</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Digital Wallet">Digital Wallet</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="reference" class="form-label">Reference No.</label>
                            <input type="text" id="reference" class="form-control" placeholder="Transaction reference">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="submit" form="recordForm" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Save Record
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Record Modal -->
<div class="modal fade" id="editRecordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Record
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRecordForm">
                    <input type="hidden" id="editRecordId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editDate" class="form-label">Date</label>
                            <input type="date" id="editDate" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editType" class="form-label">Type</label>
                            <select id="editType" class="form-select" required>
                                <option value="INCOME">Income</option>
                                <option value="EXPENSE">Expense</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCategory" class="form-label">Category</label>
                            <input type="text" id="editCategory" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editAmount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="editAmount" class="form-control" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNote" class="form-label">Note</label>
                        <textarea id="editNote" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateRecord()">
                    <i class="fas fa-save me-2"></i>Update Record
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
    <div id="successToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-check-circle text-success me-2"></i>
            <strong class="me-auto">Success</strong>
            <small class="text-muted">Just now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Operation completed successfully!
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Theme Management
    let currentTheme = localStorage.getItem('theme') || 'light';

    function initTheme() {
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeIcon();
    }

    function toggleTheme() {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        localStorage.setItem('theme', currentTheme);
        updateThemeIcon();
        showNotification(`Switched to ${currentTheme} mode`);
    }

    function updateThemeIcon() {
        const icon = document.getElementById('theme-icon');
        icon.className = currentTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    }

    function showNotification(message) {
        document.getElementById('toastMessage').textContent = message;
        const toast = new bootstrap.Toast(document.getElementById('successToast'));
        toast.show();
    }

    // Record Management Functions
    function deleteRecord(button) {
        if (confirm('Are you sure you want to delete this record?')) {
            const row = button.closest('tr');
            row.remove();
            updateSummary();
            updateRecordCount();
            showNotification('Record deleted successfully!');
        }
    }

    function editRecord(button) {
        const row = button.closest('tr');
        const cells = row.querySelectorAll('td');

        document.getElementById('editDate').value = cells[1].textContent;
        document.getElementById('editType').value = cells[2].textContent.includes('Income') ? 'INCOME' : 'EXPENSE';
        document.getElementById('editCategory').value = cells[3].textContent;
        document.getElementById('editAmount').value = cells[4].textContent.replace('₹', '').replace(/,/g, '');
        document.getElementById('editNote').value = cells[5].textContent;

        const modal = new bootstrap.Modal(document.getElementById('editRecordModal'));
        modal.show();
    }

    function updateRecord() {
        // Update logic here
        showNotification('Record updated successfully!');
        bootstrap.Modal.getInstance(document.getElementById('editRecordModal')).hide();
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.record-checkbox');

        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });

        updateDeleteButton();
    }

    function updateDeleteButton() {
        const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
        const deleteBtn = document.getElementById('deleteSelectedBtn');

        if (checkedBoxes.length > 0) {
            deleteBtn.style.display = 'inline-block';
        } else {
            deleteBtn.style.display = 'none';
        }
    }

    function deleteSelected() {
        const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
        if (checkedBoxes.length === 0) return;

        if (confirm(`Are you sure you want to delete ${checkedBoxes.length} selected record(s)?`)) {
            checkedBoxes.forEach(checkbox => {
                checkbox.closest('tr').remove();
            });
            updateSummary();
            updateRecordCount();
            updateDeleteButton();
            showNotification(`${checkedBoxes.length} record(s) deleted successfully!`);
        }
    }

    function updateSummary() {
        const rows = document.querySelectorAll('#recordsTableBody tr');
        let totalIncome = 0;
        let totalExpense = 0;

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 6) {
                const type = cells[2].textContent.trim();
                const amountText = cells[4].textContent.replace('₹', '').replace(/,/g, '');
                const amount = parseFloat(amountText) || 0;

                if (type.includes('Income')) {
                    totalIncome += amount;
                } else if (type.includes('Expense')) {
                    totalExpense += amount;
                }
            }
        });

        document.getElementById('totalIncome').textContent = `₹${totalIncome.toLocaleString('en-IN')}`;
        document.getElementById('totalExpense').textContent = `₹${totalExpense.toLocaleString('en-IN')}`;
        document.getElementById('netAmount').textContent = `₹${(totalIncome - totalExpense).toLocaleString('en-IN')}`;
    }

    function updateRecordCount() {
        const rows = document.querySelectorAll('#recordsTableBody tr');
        const count = rows.length;
        document.getElementById('totalRecords').textContent = count;
    }

    // Filter Functions
    function applyFilters() {
        const searchTerm = document.getElementById('recordSearch').value.toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const rows = document.querySelectorAll('#recordsTableBody tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length < 6) return;

            let show = true;

            // Search term filter
            if (searchTerm && !row.textContent.toLowerCase().includes(searchTerm)) {
                show = false;
            }

            // Type filter
            if (typeFilter && !cells[2].textContent.includes(typeFilter === 'INCOME' ? 'Income' : 'Expense')) {
                show = false;
            }

            // Category filter
            if (categoryFilter && cells[3].textContent !== categoryFilter) {
                show = false;
            }

            // Date range filter
            if (startDate || endDate) {
                const rowDate = new Date(cells[1].textContent);
                if (startDate && rowDate < new Date(startDate)) show = false;
                if (endDate && rowDate > new Date(endDate)) show = false;
            }

            row.style.display = show ? '' : 'none';
        });

        showNotification('Filters applied successfully!');
    }

    function clearFilters() {
        document.getElementById('recordSearch').value = '';
        document.getElementById('typeFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';

        const rows = document.querySelectorAll('#recordsTableBody tr');
        rows.forEach(row => row.style.display = '');

        showNotification('Filters cleared!');
    }

    function sortTable(column) {
        const table = document.getElementById('recordsTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        const columnIndex = column === 'date' ? 1 : 4; // Date or Amount column

        rows.sort((a, b) => {
            const aVal = a.cells[columnIndex].textContent;
            const bVal = b.cells[columnIndex].textContent;

            if (column === 'date') {
                return new Date(aVal) - new Date(bVal);
            } else {
                const aAmount = parseFloat(aVal.replace('₹', '').replace(/,/g, '')) || 0;
                const bAmount = parseFloat(bVal.replace('₹', '').replace(/,/g, '')) || 0;
                return bAmount - aAmount; // Descending order for amount
            }
        });

        rows.forEach(row => tbody.appendChild(row));
        showNotification(`Table sorted by ${column}`);
    }

    function exportRecords() {
        const data = [];
        const rows = document.querySelectorAll('#recordsTableBody tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 6) {
                data.push({
                    date: cells[1].textContent,
                    type: cells[2].textContent.trim(),
                    category: cells[3].textContent,
                    amount: cells[4].textContent,
                    note: cells[5].textContent
                });
            }
        });

        const headers = ['Date', 'Type', 'Category', 'Amount', 'Note'];
        const csvContent = [
            headers.join(','),
            ...data.map(row => Object.values(row).map(val => `"${val}"`).join(','))
        ].join('\n');

        downloadFile(csvContent, 'records.csv', 'text/csv');
    }

    function downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showNotification(`${filename} downloaded successfully!`);
    }

    function updateCategoryOptions() {
        const type = document.getElementById('type').value;
        const categoryList = document.getElementById('categoryList');

        if (type === 'INCOME') {
            categoryList.innerHTML = `
                    <option value="Sales">
                    <option value="Service Income">
                    <option value="Interest">
                    <option value="Other Income">
                `;
        } else if (type === 'EXPENSE') {
            categoryList.innerHTML = `
                    <option value="Office Supplies">
                    <option value="Marketing">
                    <option value="Travel">
                    <option value="Utilities">
                    <option value="Professional Services">
                    <option value="Equipment">
                `;
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        initTheme();
        updateSummary();
        updateRecordCount();

        // Set today's date as default
        document.getElementById('date').value = new Date().toISOString().split('T')[0];

        // Add event listeners for checkboxes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('record-checkbox')) {
                updateDeleteButton();
            }
        });

        // Real-time search
        document.getElementById('recordSearch').addEventListener('input', debounce(applyFilters, 300));
    });

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'n':
                    e.preventDefault();
                    const modal = new bootstrap.Modal(document.getElementById('addRecordModal'));
                    modal.show();
                    break;
                case 'd':
                    e.preventDefault();
                    toggleTheme();
                    break;
                case 'e':
                    e.preventDefault();
                    exportRecords();
                    break;
            }
        }
    });

    // Form validation
    document.getElementById('recordForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (this.checkValidity()) {
            showNotification('Record saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('addRecordModal')).hide();
            this.reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        } else {
            this.classList.add('was-validated');
        }
    });
</script>
</body>
</html>